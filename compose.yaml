services:
  app:
    image: ghcr.io/pedrowork/pesquisa:latest
    cpus: "0.5"
    mem_limit: 2G
    container_name: pesquisa-app
    environment: &app_environment
      APP_NAME: Pesquisa
      APP_ENV: production
      APP_KEY: ${APP_KEY}
      APP_URL: https://pesquisa.techsistema.com.br
      APP_LOCALE: pt_BR
      LOG_CHANNEL: nightwatch
      LOG_STACK: single,nightwatch
      LOG_DEPRECATIONS_CHANNEL: null
      LOG_LEVEL: debug
      TZ: America/Sao_Paulo

      DB_CONNECTION: pgsql
      DB_HOST: postgres
      DB_PORT: "5432"
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}

      REDIS_HOST: redis
      REDIS_PORT: "6379"
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_CLIENT: phpredis
      CACHE_STORE: redis
      QUEUE_CONNECTION: redis
      BROADCAST_CONNECTION: reverb
      SESSION_DRIVER: redis
      SESSION_LIFETIME: "120"
      SESSION_PATH: /
      SESSION_DOMAIN: null

      MAIL_MAILER: resend
      MAIL_FROM_ADDRESS: contato@pesquisa.com.br
      MAIL_FROM_NAME: Pesquisa
      VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY}
      VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY}

      ASSET_URL: https://pesquisa.techsistema.com.br
      INERTIA_SSR_URL: http://ssr:13714

      NIGHTWATCH_TOKEN: ${NIGHTWATCH_TOKEN}
      NIGHTWATCH_REQUEST_SAMPLE_RATE: "0.1"
      NIGHTWATCH_INGEST_URI: nightwatch-agent:2407
      RESEND_API_KEY: ${RESEND_API_KEY}

      REVERB_APP_ID: ${REVERB_APP_ID}
      REVERB_APP_KEY: ${REVERB_APP_KEY}
      REVERB_APP_SECRET: ${REVERB_APP_SECRET}
      REVERB_HOST: ${REVERB_HOST:-eco.pesquisa.com.br}
      REVERB_PORT: ${REVERB_PORT:-443}
      REVERB_SCHEME: ${REVERB_SCHEME:-https}
      REVERB_SERVER_HOST: 0.0.0.0
      REVERB_SERVER_PORT: 8080

      VITE_REVERB_APP_KEY: ${REVERB_APP_KEY}
      VITE_REVERB_HOST: ${REVERB_HOST:-eco.pesquisa.com.br}
      VITE_REVERB_PORT: ${REVERB_PORT:-443}
      VITE_REVERB_SCHEME: ${REVERB_SCHEME:-https}
    volumes:
      - storage:/var/www/html/storage
      - cache:/var/www/html/bootstrap/cache
    restart: unless-stopped
    depends_on:
      nightwatch-agent:
        condition: service_started
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - default
      - infra-network
    healthcheck:
      test: ["CMD-SHELL", "pidof php-fpm > /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    stop_grace_period: 30s

  web:
    image: ghcr.io/pedrowork/pesquisa-web:latest
    container_name: pesquisa
    cpus: "0.5"
    mem_limit: 1G
    # environment:
    #   VITE_REVERB_APP_KEY: ${REVERB_APP_KEY}
    #   VITE_REVERB_HOST: ${REVERB_HOST:-eco.pesquisa.com.br}
    #   VITE_REVERB_PORT: ${REVERB_PORT:-443}
    #   VITE_REVERB_SCHEME: ${REVERB_SCHEME:-https}
    depends_on:
      - app
    restart: unless-stopped
    networks:
      - default
      - infra-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    stop_grace_period: 20s

  ssr:
    image: ghcr.io/pedrowork/pesquisa-ssr:latest
    container_name: pesquisa-ssr
    cpus: "0.5"
    mem_limit: 1G
    environment: *app_environment
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://localhost:13714/health').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - default
    stop_grace_period: 15s

  horizon:
    image: ghcr.io/pedrowork/pesquisa-app:latest
    cpus: "0.5"
    mem_limit: 1G
    environment: *app_environment
    command: ["php", "artisan", "horizon"]
    restart: unless-stopped
    depends_on:
      app:
        condition: service_healthy
      nightwatch-agent:
        condition: service_started
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - default
      - infra-network
    healthcheck:
      test: ["CMD", "ps", "aux", "|", "grep", "-q", "horizon"]
      interval: 30s
      timeout: 5s
      retries: 3
    stop_grace_period: 30s

  scheduler:
    image: ghcr.io/pedrowork/pesquisa-app:latest
    cpus: "0.5"
    mem_limit: 512M
    environment: *app_environment
    command: ["php", "artisan", "schedule:work"]
    restart: unless-stopped
    depends_on:
      app:
        condition: service_healthy
      nightwatch-agent:
        condition: service_started
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - default
      - infra-network
    healthcheck:
      test: ["CMD", "ps", "aux", "|", "grep", "-q", "schedule:work"]
      interval: 30s
      timeout: 5s
      retries: 3
    stop_grace_period: 15s

  reverb:
    image: ghcr.io/pedrowork/pesquisa-app:latest
    container_name: pesquisa-reverb
    cpus: "0.5"
    mem_limit: 512M
    environment: *app_environment
    command: ["php", "artisan", "reverb:start", "--host=0.0.0.0", "--port=8080"]
    restart: unless-stopped
    depends_on:
      app:
        condition: service_healthy
      nightwatch-agent:
        condition: service_started
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - default
      - infra-network
    healthcheck:
      test:
        ["CMD-SHELL", 'php -r "exit((int)!@fsockopen(''localhost'', 8080));"']
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    stop_grace_period: 15s

  nightwatch-agent:
    image: laravelphp/nightwatch-agent:latest
    cpus: "0.5"
    mem_limit: 256M
    environment:
      NIGHTWATCH_TOKEN: ${NIGHTWATCH_TOKEN}
    restart: unless-stopped
    healthcheck:
      test: php nightwatch-status
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s
    stop_grace_period: 10s

  postgres:
    image: postgres:16-alpine
    container_name: pesquisa-postgres
    cpus: "0.5"
    mem_limit: 512M
    environment:
      POSTGRES_DB: ${DB_DATABASE:-pesquisa}
      POSTGRES_USER: ${DB_USERNAME:-pesquisa}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      TZ: America/Sao_Paulo
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - default
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${DB_USERNAME:-pesquisa} -d ${DB_DATABASE:-pesquisa}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    stop_grace_period: 30s

  redis:
    image: redis:7-alpine
    container_name: pesquisa-redis
    cpus: "0.25"
    mem_limit: 256M
    command: redis-server --requirepass ${REDIS_PASSWORD}
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      TZ: America/Sao_Paulo
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - default
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    stop_grace_period: 10s

volumes:
  storage: {}
  cache: {}
  postgres_data:
    external: true
    name: pesquisa_postgres_data
  redis_data: {}

networks:
  infra-network:
    external: true
    name: infra-network
