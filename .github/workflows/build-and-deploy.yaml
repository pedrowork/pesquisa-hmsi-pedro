name: Docker Build and Publish

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: false

on:
    push:
        branches:
            - main
        tags:
            - 'v*'
        paths-ignore:
            - compose.yml
            - compose.dev.yml
            - README.md
            - 'tests/**'
            - vitest.config.ts
            - eslint.config.js
            - '*.md'
            - 'docs/**'

    pull_request:
        branches:
            - main
        paths-ignore:
            - compose.yml
            - compose.dev.yml
            - README.md
            - 'tests/**'
            - vitest.config.ts
            - eslint.config.js
            - '*.md'
    workflow_dispatch:

env:
    REGISTRY: ghcr.io
    OWNER: ${{ github.repository_owner }}

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata for app
              id: meta_app
              uses: docker/metadata-action@v5
              with:
                  images: ghcr.io/${{ env.OWNER }}/pesquisa-app
                  tags: |
                      type=ref,event=branch
                      type=raw,value=develop,enable=${{ github.event_name == 'pull_request' }}
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=semver,pattern={{major}}
                      type=sha,format=short
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Extract metadata for web
              id: meta_web
              uses: docker/metadata-action@v5
              with:
                  images: ghcr.io/${{ env.OWNER }}/pesquisa-web
                  tags: |
                      type=ref,event=branch
                      type=raw,value=develop,enable=${{ github.event_name == 'pull_request' }}
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=semver,pattern={{major}}
                      type=sha,format=short
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Extract metadata for ssr
              id: meta_ssr
              uses: docker/metadata-action@v5
              with:
                  images: ghcr.io/${{ env.OWNER }}/pesquisa-ssr
                  tags: |
                      type=ref,event=branch
                      type=raw,value=develop,enable=${{ github.event_name == 'pull_request' }}
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=semver,pattern={{major}}
                      type=sha,format=short
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Build & push app
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: ./docker/Dockerfile
                  target: app
                  push: true
                  tags: ${{ steps.meta_app.outputs.tags }}
                  labels: ${{ steps.meta_app.outputs.labels }}
                  platforms: linux/amd64
                  build-args: |
                      VITE_REVERB_APP_KEY=${{ secrets.REVERB_APP_KEY }}
                      VITE_REVERB_HOST=${{ vars.REVERB_HOST }}
                      VITE_REVERB_PORT=${{ vars.REVERB_PORT }}
                      VITE_REVERB_SCHEME=${{ vars.REVERB_SCHEME }}
                  cache-from: |
                      type=gha,scope=app
                      type=gha,scope=web
                      type=gha,scope=ssr
                  cache-to: type=gha,mode=max,scope=app

            - name: Build & push web
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: ./docker/Dockerfile
                  target: nginx
                  push: true
                  tags: ${{ steps.meta_web.outputs.tags }}
                  labels: ${{ steps.meta_web.outputs.labels }}
                  platforms: linux/amd64
                  build-args: |
                      VITE_REVERB_APP_KEY=${{ secrets.REVERB_APP_KEY }}
                      VITE_REVERB_HOST=${{ vars.REVERB_HOST }}
                      VITE_REVERB_PORT=${{ vars.REVERB_PORT }}
                      VITE_REVERB_SCHEME=${{ vars.REVERB_SCHEME }}
                  cache-from: |
                      type=gha,scope=web
                      type=gha,scope=app
                      type=gha,scope=ssr
                  cache-to: type=gha,mode=max,scope=web

            - name: Build & push ssr
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: ./docker/Dockerfile
                  target: ssr
                  push: true
                  tags: ${{ steps.meta_ssr.outputs.tags }}
                  labels: ${{ steps.meta_ssr.outputs.labels }}
                  platforms: linux/amd64
                  build-args: |
                      VITE_REVERB_APP_KEY=${{ secrets.REVERB_APP_KEY }}
                      VITE_REVERB_HOST=${{ vars.REVERB_HOST }}
                      VITE_REVERB_PORT=${{ vars.REVERB_PORT }}
                      VITE_REVERB_SCHEME=${{ vars.REVERB_SCHEME }}
                  cache-from: |
                      type=gha,scope=ssr
                      type=gha,scope=app
                      type=gha,scope=web
                  cache-to: type=gha,mode=max,scope=ssr

    deploy:
        runs-on: ubuntu-latest
        needs: build-and-push
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
            DEPLOY_PATH: ${{ vars.DEPLOY_PATH || '/home/deploy/projetos/pesquisa-hmsi-pedro' }}

        steps:

            - name: executing remote ssh commands using ssh key
              uses: appleboy/ssh-action@v1.2.3
              with:
                  host: ${{ secrets.SSH_HOST }}
                  username: ${{ secrets.SSH_USERNAME }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  port: ${{ secrets.SSH_PORT || 22 }}
                  script: |
                      cd ${{ env.DEPLOY_PATH }}
                      docker compose pull
                      docker compose up -d --remove-orphans
                      docker image prune -f

    health-check:
        runs-on: ubuntu-latest
        needs: deploy
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        steps:
            - name: Wait for app to be ready
              run: sleep 30

            - name: Check the URL health
              uses: jtalk/url-health-check-action@v4
              with:
                  url: https://${{ secrets.APP_URL }}/up
                  max-attempts: 3
                  retry-delay: 10s
                  follow-redirect: false
